<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ê±âÂ≠óÊèèÊëπÊùø (Hanzi Tracing Pad)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles - Flexbox Layout */
        html, body {
            height: 100%; overflow: hidden;
            margin: 0; padding: 0; font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background-color: #f0f9ff;
        }
        body {
             /* Removed flex settings from body */
             height: 100vh; /* Ensure body takes full viewport height */
             position: relative; /* Keep for absolute TOC if needed, though not used now */
        }

        /* Page Title - Now part of main content flow */
        #pageTitle {
             text-align: center; padding: 0.5rem 0; /* Keep top/bottom padding */
             font-size: 1.8rem; font-weight: bold; color: #1d4ed8;
             width: 100%;
             max-width: 900px; /* Match controls max-width? */
             flex-shrink: 0;
             order: 0; /* Ensure title is at the top of mainContentArea */
        }

        /* Flex Layout Container (Holds TOC and Main Content) */
        .layout-container {
            display: flex; /* Use flex row for TOC and Main Content */
            /* Removed flex-grow, height is now 100% */
            overflow: hidden;
            width: 100%;
            height: 100%; /* Fill body height */
        }

        /* TOC Sidebar - Flex Item */
        #tocContainer {
            width: 110px;
            flex-shrink: 0;
            height: 100%;
            overflow-y: auto;
            background-color: #e0f2fe;
            border-right: 2px solid #bae6fd;
            padding: 0.5rem;
        }
        .toc-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 0.5rem; }
        .toc-item { font-family: 'Noto Sans SC', sans-serif; font-size: 1.8rem; padding: 0.3rem; text-align: center; cursor: pointer; border-radius: 0.375rem; background-color: #ffffff; transition: background-color 0.2s ease; user-select: none; border: 1px solid #d1d5db; }
        .toc-item:hover { background-color: #bfdbfe; }
        .toc-item.active { background-color: #3b82f6; color: white; font-weight: bold; border-color: #2563eb; }

        /* Main Content Area - Flex Item */
        #mainContentArea {
            flex-grow: 1;
            display: flex; flex-direction: column; align-items: center; /* Center content horizontally */
            height: 100%;
            overflow-y: auto; /* Allow content area to scroll */
            padding: 1rem;
            box-sizing: border-box;
            background-color: #f0f9ff;
        }
        /* Adjust fullscreen styles */
        #mainContentArea:fullscreen { background-color: #f0f9ff; padding: 1rem; }
        #mainContentArea:-webkit-full-screen { background-color: #f0f9ff; padding: 1rem; }
        #mainContentArea:-moz-full-screen { background-color: #f0f9ff; padding: 1rem; }
        #mainContentArea:-ms-fullscreen { background-color: #f0f9ff; padding: 1rem; }


        /* Meaning/Emoji Container */
        .meaning-container {
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 1.5rem;
            min-height: auto; flex-shrink: 0;
            background-color: #ffffff; border-radius: 50%;
            width: 110px; height: 110px; padding: 0.5rem;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1); border: 2px solid #e5e7eb;
            order: 1; /* Comes after title */
        }
        #meaningEmoji { font-size: 5rem; line-height: 1; text-align: center; }

         /* Container for Animation and Quiz */
        .writer-container {
            display: flex;
            flex-direction: column; /* Default: Stack vertically */
            align-items: center;
            gap: 1.5rem;
            width: 100%;
            max-width: 700px;
            flex-shrink: 0;
            order: 2; /* Comes after emoji */
        }

        /* Individual Hanzi Writer Target Containers */
        .hanzi-target {
            width: 100%;
            max-width: 650px;
            height: auto;
            aspect-ratio: 1 / 1;
            border: 2px solid #e5e7eb; border-radius: 0.75rem; overflow: hidden;
            background-color: white;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.08);
            position: relative;
        }
        .hanzi-target > svg { width: 100%; height: 100%; display: block; position: relative; z-index: 1; }

        /* Mizige Grid using CSS Background on the Quiz Target */
        #quizTarget {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M0 50 H100 M50 0 V100 M0 0 L100 100 M100 0 L0 100' stroke='%23e5e7eb' stroke-width='1' stroke-dasharray='3 3'/%3E%3C/svg%3E");
            background-size: 100% 100%; background-repeat: no-repeat;
        }

        /* Media Query for wider/landscape screens */
        @media (min-aspect-ratio: 10/9) and (min-width: 1024px) {
             .writer-container {
                 flex-direction: row; align-items: flex-start;
                 max-width: 900px;
                 gap: 2rem;
             }
             .hanzi-target {
                 flex: 1; width: auto; max-width: 400px;
             }
        }

        /* Buttons */
        .control-button { display: inline-block; padding: 0.8rem 1.5rem; font-size: 1.2rem; font-weight: bold; color: white; background-color: #3b82f6; border: none; border-radius: 0.75rem; cursor: pointer; text-align: center; text-decoration: none; transition: background-color 0.3s ease, opacity 0.3s ease; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .control-button:hover:not(:disabled) { background-color: #2563eb; }
        .control-button:active:not(:disabled) { background-color: #1d4ed8; transform: translateY(1px); }
        .control-button:disabled { background-color: #9ca3af; opacity: 0.7; cursor: not-allowed; }
        #fullscreenBtn { background-color: #10b981; } #fullscreenBtn:hover:not(:disabled) { background-color: #059669; } #fullscreenBtn:active:not(:disabled) { background-color: #047857; }
        #prevBtn { background-color: #f59e0b; } #prevBtn:hover:not(:disabled) { background-color: #d97706; } #prevBtn:active:not(:disabled) { background-color: #b45309; }
        #clearBtn { background-color: #ef4444; } #clearBtn:hover:not(:disabled) { background-color: #dc2626; } #clearBtn:active:not(:disabled) { background-color: #b91c1c; }
        #oldVersionLink { background-color: #6b7280; } #oldVersionLink:hover { background-color: #4b5563; } #oldVersionLink:active { background-color: #374151; }

        /* Controls Container */
        .controls-container {
            display: flex; flex-wrap: wrap; justify-content: center; align-items: center;
            gap: 1rem; margin-top: 1.5rem; padding: 0 1rem; width: 100%; max-width: 900px; flex-shrink: 0;
            order: 3; /* Comes after writer container */
        }
        .checkbox-container { display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem; color: #1f2937; }
        #randomCheckbox { width: 1.2rem; height: 1.2rem; cursor: pointer; }

    </style>
</head>
<body>
    <div class="layout-container">
        <div id="tocContainer">
            <div id="tocList" class="toc-list"></div>
        </div>

        <div id="mainContentArea">
             <h1 id="pageTitle">Ê±âÂ≠óÊèèÊëπÊùø</h1>

             <div class="meaning-container">
                <span id="meaningEmoji" aria-hidden="true"></span>
            </div>

            <div class="writer-container">
                <div id="animationTarget" class="hanzi-target"></div>
                <div id="quizTarget" class="hanzi-target"></div>
            </div>

            <div class="controls-container">
                <button id="clearBtn" class="control-button">ÈáçËØï (Retry)</button>
                <button id="prevBtn" class="control-button">‰∏ä‰∏Ä‰∏™ (Prev)</button>
                <button id="nextBtn" class="control-button">‰∏ã‰∏Ä‰∏™ (Next)</button>
                <button id="fullscreenBtn" class="control-button">ÂÖ®Â±è (Fullscreen)</button>
                 <a href="./index_old.html" id="oldVersionLink" class="control-button">Old Version</a>
                <div class="checkbox-container">
                    <input type="checkbox" id="randomCheckbox">
                    <label for="randomCheckbox">ÈöèÊú∫È°∫Â∫è (Random Order)</label>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const characters = [ /* ... (character list remains the same) ... */
             // Numbers & Basics
            { char: '‰∏Ä', pinyin: 'yƒ´', meaning: 'one', emoji: '1Ô∏è‚É£' }, { char: '‰∫å', pinyin: '√®r', meaning: 'two', emoji: '2Ô∏è‚É£' }, { char: '‰∏â', pinyin: 'sƒÅn', meaning: 'three', emoji: '3Ô∏è‚É£' }, { char: 'Âõõ', pinyin: 's√¨', meaning: 'four', emoji: '4Ô∏è‚É£' }, { char: '‰∫î', pinyin: 'w«î', meaning: 'five', emoji: '5Ô∏è‚É£' }, { char: 'ÂÖ≠', pinyin: 'li√π', meaning: 'six', emoji: '6Ô∏è‚É£' }, { char: '‰∏É', pinyin: 'qƒ´', meaning: 'seven', emoji: '7Ô∏è‚É£' }, { char: 'ÂÖ´', pinyin: 'bƒÅ', meaning: 'eight', emoji: '8Ô∏è‚É£' }, { char: '‰πù', pinyin: 'ji«î', meaning: 'nine', emoji: '9Ô∏è‚É£' }, { char: 'ÂçÅ', pinyin: 'sh√≠', meaning: 'ten', emoji: 'üîü' }, { char: 'Áôæ', pinyin: 'b«éi', meaning: 'hundred', emoji: 'üíØ' }, { char: '‰∫∫', pinyin: 'r√©n', meaning: 'person', emoji: 'üë§' }, { char: 'Â§ß', pinyin: 'd√†', meaning: 'big', emoji: 'üêò' }, { char: 'Â∞è', pinyin: 'xi«éo', meaning: 'small', emoji: 'üêú' }, { char: 'Âè£', pinyin: 'k«íu', meaning: 'mouth', emoji: 'üëÑ' }, { char: '‰∏≠', pinyin: 'zh≈çng', meaning: 'middle', emoji: 'üéØ' }, { char: 'ÂõΩ', pinyin: 'gu√≥', meaning: 'country', emoji: 'üó∫Ô∏è' },
            // Nature
            { char: 'Êó•', pinyin: 'r√¨', meaning: 'sun', emoji: '‚òÄÔ∏è' }, { char: 'Êúà', pinyin: 'yu√®', meaning: 'moon', emoji: 'üåô' }, { char: 'Êú®', pinyin: 'm√π', meaning: 'wood', emoji: 'üå≥' }, { char: 'Ê∞¥', pinyin: 'shu«ê', meaning: 'water', emoji: 'üíß' }, { char: 'ÁÅ´', pinyin: 'hu«í', meaning: 'fire', emoji: 'üî•' }, { char: 'Â±±', pinyin: 'shƒÅn', meaning: 'mountain', emoji: '‚õ∞Ô∏è' }, { char: 'Áî∞', pinyin: 'ti√°n', meaning: 'field', emoji: 'üèûÔ∏è' }, { char: 'Âúü', pinyin: 't«î', meaning: 'earth', emoji: 'üß±' }, { char: 'Â§©', pinyin: 'tiƒÅn', meaning: 'sky / day', emoji: '‚òÅÔ∏è' }, { char: '‰∫ë', pinyin: 'y√∫n', meaning: 'cloud', emoji: '‚òÅÔ∏è' }, { char: 'Èõ®', pinyin: 'y«î', meaning: 'rain', emoji: 'üåßÔ∏è' }, { char: 'Ëä±', pinyin: 'huƒÅ', meaning: 'flower', emoji: 'üå∏' }, { char: 'Ëçâ', pinyin: 'c«éo', meaning: 'grass', emoji: 'üåø' }, { char: 'È£é', pinyin: 'fƒìng', meaning: 'wind', emoji: 'üå¨Ô∏è' }, { char: 'Áü≥', pinyin: 'sh√≠', meaning: 'stone', emoji: 'ü™®' },
            // Animals
            { char: 'Áâõ', pinyin: 'ni√∫', meaning: 'cow', emoji: 'üêÆ' }, { char: 'Áæä', pinyin: 'y√°ng', meaning: 'sheep', emoji: 'üêë' }, { char: 'È©¨', pinyin: 'm«é', meaning: 'horse', emoji: 'üê¥' }, { char: 'È±º', pinyin: 'y√∫', meaning: 'fish', emoji: 'üê†' }, { char: 'È∏ü', pinyin: 'ni«éo', meaning: 'bird', emoji: 'üê¶' }, { char: 'Ëô´', pinyin: 'ch√≥ng', meaning: 'insect', emoji: 'üêõ' }, { char: 'Áãó', pinyin: 'g«íu', meaning: 'dog', emoji: 'üê∂' }, { char: 'Áå´', pinyin: 'mƒÅo', meaning: 'cat', emoji: 'üê±' }, { char: 'ÂÖî', pinyin: 't√π', meaning: 'rabbit', emoji: 'üê∞' },
            // Family & People
            { char: 'Áà∏', pinyin: 'b√†', meaning: 'dad', emoji: 'üë®' }, { char: 'Â¶à', pinyin: 'mƒÅ', meaning: 'mom', emoji: 'üë©' }, { char: 'Êàë', pinyin: 'w«í', meaning: 'I / me', emoji: 'üôã' }, { char: '‰Ω†', pinyin: 'n«ê', meaning: 'you', emoji: 'üëâ' }, { char: '‰ªñ', pinyin: 'tƒÅ', meaning: 'he / him', emoji: 'üßç‚Äç‚ôÇÔ∏è' }, { char: 'Â•π', pinyin: 'tƒÅ', meaning: 'she / her', emoji: 'üßç‚Äç‚ôÄÔ∏è' }, { char: 'ÂÆ∂', pinyin: 'jiƒÅ', meaning: 'home / family', emoji: 'üè†' }, { char: 'Â≠ê', pinyin: 'z«ê', meaning: 'child / son', emoji: 'üë∂' }, { char: 'Â•≥', pinyin: 'n«ö', meaning: 'female / woman', emoji: '‚ôÄÔ∏è' }, { char: 'Áî∑', pinyin: 'n√°n', meaning: 'male / man', emoji: '‚ôÇÔ∏è' }, { char: 'Âèã', pinyin: 'y«íu', meaning: 'friend', emoji: 'üßë‚Äçü§ù‚Äçüßë' }, { char: 'Áîü', pinyin: 'shƒìng', meaning: 'birth / life', emoji: 'üå±' },
            // Actions & Verbs
            { char: 'Áà±', pinyin: '√†i', meaning: 'love', emoji: '‚ù§Ô∏è' }, { char: 'Áúã', pinyin: 'k√†n', meaning: 'look / see', emoji: 'üëÄ' }, { char: 'ÂêÉ', pinyin: 'chƒ´', meaning: 'eat', emoji: 'üçé' }, { char: 'Âñù', pinyin: 'hƒì', meaning: 'drink', emoji: 'ü•§' }, { char: 'Âéª', pinyin: 'q√π', meaning: 'go', emoji: '‚û°Ô∏è' }, { char: 'Êù•', pinyin: 'l√°i', meaning: 'come', emoji: '‚¨ÖÔ∏è' }, { char: 'Ëµ∞', pinyin: 'z«íu', meaning: 'walk', emoji: 'üö∂' }, { char: 'Âùê', pinyin: 'zu√≤', meaning: 'sit', emoji: 'üßò' }, { char: 'ËØ¥', pinyin: 'shu≈ç', meaning: 'speak / say', emoji: 'üó£Ô∏è' }, { char: 'Á¨ë', pinyin: 'xi√†o', meaning: 'laugh / smile', emoji: 'üòä' }, { char: 'Âì≠', pinyin: 'k≈´', meaning: 'cry', emoji: 'üò¢' }, { char: 'Êúâ', pinyin: 'y«íu', meaning: 'have / there is', emoji: '‚úÖ' }, { char: 'Êó†', pinyin: 'w√∫', meaning: 'not have / without', emoji: '‚ùå' }, { char: 'ÊòØ', pinyin: 'sh√¨', meaning: 'to be (is, am, are)', emoji: '‚úîÔ∏è' }, { char: 'Âú®', pinyin: 'z√†i', meaning: 'at / in / on', emoji: 'üìç' }, { char: 'Â≠¶', pinyin: 'xu√©', meaning: 'learn / study', emoji: 'üìö' }, { char: 'ÂÜô', pinyin: 'xiƒõ', meaning: 'write', emoji: '‚úçÔ∏è' }, { char: 'Áîª', pinyin: 'hu√†', meaning: 'draw / picture', emoji: 'üé®' }, { char: 'Áé©', pinyin: 'w√°n', meaning: 'play', emoji: '‚öΩ' },
            // Objects & Things
            { char: 'ËΩ¶', pinyin: 'chƒì', meaning: 'car / vehicle', emoji: 'üöó' }, { char: 'Èó®', pinyin: 'm√©n', meaning: 'door', emoji: 'üö™' }, { char: '‰π¶', pinyin: 'sh≈´', meaning: 'book', emoji: 'üìñ' }, { char: 'Á¨î', pinyin: 'b«ê', meaning: 'pen', emoji: 'üñäÔ∏è' }, { char: 'ÂàÄ', pinyin: 'dƒÅo', meaning: 'knife', emoji: 'üî™' }, { char: 'Êâã', pinyin: 'sh«íu', meaning: 'hand', emoji: 'üñêÔ∏è' }, { char: 'Ë∂≥', pinyin: 'z√∫', meaning: 'foot', emoji: 'ü¶∂' }, { char: 'Â§¥', pinyin: 't√≥u', meaning: 'head', emoji: 'üë§' }, { char: 'ÂøÉ', pinyin: 'xƒ´n', meaning: 'heart', emoji: '‚ù§Ô∏è' }, { char: 'Ë°£', pinyin: 'yƒ´', meaning: 'clothes', emoji: 'üëï' }, { char: 'Á±≥', pinyin: 'm«ê', meaning: 'rice', emoji: 'üçö' }, { char: 'Áìú', pinyin: 'guƒÅ', meaning: 'melon', emoji: 'üçâ' },
            // Directions & Position
            { char: '‰∏ä', pinyin: 'sh√†ng', meaning: 'up / on', emoji: '‚¨ÜÔ∏è' }, { char: '‰∏ã', pinyin: 'xi√†', meaning: 'down / under', emoji: '‚¨áÔ∏è' }, { char: 'Â∑¶', pinyin: 'zu«í', meaning: 'left', emoji: '‚¨ÖÔ∏è' }, { char: 'Âè≥', pinyin: 'y√≤u', meaning: 'right', emoji: '‚û°Ô∏è' }, { char: 'Ââç', pinyin: 'qi√°n', meaning: 'front / before', emoji: 'üîº' }, { char: 'Âêé', pinyin: 'h√≤u', meaning: 'back / after', emoji: 'üîΩ' }, { char: '‰∏ú', pinyin: 'd≈çng', meaning: 'east', emoji: 'üá™' }, { char: 'Ë•ø', pinyin: 'xƒ´', meaning: 'west', emoji: 'üáº' }, { char: 'Âçó', pinyin: 'n√°n', meaning: 'south', emoji: 'üá∏' }, { char: 'Âåó', pinyin: 'bƒõi', meaning: 'north', emoji: 'üá≥' },
            // Adjectives & Others
            { char: 'Â•Ω', pinyin: 'h«éo', meaning: 'good / well', emoji: 'üëç' }, { char: '‰∏ç', pinyin: 'b√π', meaning: 'not / no', emoji: 'üö´' }, { char: 'Â§ö', pinyin: 'du≈ç', meaning: 'many / much', emoji: '‚ûï' }, { char: 'Â∞ë', pinyin: 'sh«éo', meaning: 'few / little', emoji: '‚ûñ' }, { char: 'È´ò', pinyin: 'gƒÅo', meaning: 'high / tall', emoji: 'ü¶í' }, { char: 'Èïø', pinyin: 'ch√°ng', meaning: 'long', emoji: 'üìè' }, { char: 'Á∫¢', pinyin: 'h√≥ng', meaning: 'red', emoji: 'üü•' }, { char: 'ÁôΩ', pinyin: 'b√°i', meaning: 'white', emoji: '‚¨ú' }, { char: 'Èªë', pinyin: 'hƒìi', meaning: 'black', emoji: '‚¨õ' }, { char: 'ÈªÑ', pinyin: 'hu√°ng', meaning: 'yellow', emoji: 'üü®' }, { char: 'Áªø', pinyin: 'l«ú', meaning: 'green', emoji: 'üü©' }, { char: 'Ëìù', pinyin: 'l√°n', meaning: 'blue', emoji: 'üü¶' }, { char: 'ÂºÄ', pinyin: 'kƒÅi', meaning: 'open / start', emoji: 'üîì' }, { char: 'ÂÖ≥', pinyin: 'guƒÅn', meaning: 'close / turn off', emoji: 'üîí' },
        ];
        let currentCharacterIndex = 0;
        const encouragementPhrases = [ /* ... (phrase list remains the same) ... */
            "Â§™Ê£í‰∫Ü!", "Áúü‰∏çÈîô!", "ÊúâËøõÊ≠•!", "ÂÜôÂæóÂæàÂ•Ω!", "ÁªßÁª≠Âä†Ê≤π!",
            "Â•ΩÊûÅ‰∫Ü!", "ÁúüÂéâÂÆ≥!", "‰Ω†ÁúüÊ£í!", "ÊºÇ‰∫Æ!", "‰Ω†ÂÜôÁöÑÁúüÂ•Ω!"
        ];

        // --- Hanzi Writer Instances ---
        let animationWriter = null;
        let quizWriter = null;
        const animationTargetDiv = document.getElementById('animationTarget');
        const quizTargetDiv = document.getElementById('quizTarget');

        // --- DOM Elements ---
        const tocListContainer = document.getElementById('tocList');
        const meaningEmoji = document.getElementById('meaningEmoji');
        const clearBtn = document.getElementById('clearBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const randomCheckbox = document.getElementById('randomCheckbox');

        // --- State Flags ---
        let isInitializing = true;

        // --- Speech Synthesis ---
        const synth = window.speechSynthesis;
        let voices = [];
        function populateVoiceList() { /* ... (no changes) ... */ if(typeof speechSynthesis === 'undefined') { console.warn("Speech Synthesis not supported."); return; } voices = synth.getVoices().filter(voice => voice.lang.startsWith('zh')); if (voices.length === 0 && synth.onvoiceschanged !== undefined) { synth.onvoiceschanged = () => { voices = synth.getVoices().filter(voice => voice.lang.startsWith('zh')); console.log("Voices loaded:", voices); }; } else { console.log("Chinese voices found:", voices); } }
        populateVoiceList();
        if (typeof speechSynthesis !== 'undefined' && speechSynthesis.onvoiceschanged !== undefined) { speechSynthesis.onvoiceschanged = populateVoiceList; }
        function speak(textToSpeak, langCode = 'zh-CN', interrupt = false) { /* ... (no changes) ... */ if (!synth) { console.warn("Speech Synthesis not available."); return; } if (interrupt || synth.speaking) { synth.cancel(); } if (textToSpeak !== '') { const utterThis = new SpeechSynthesisUtterance(textToSpeak); utterThis.onerror = (event) => console.error('SpeechSynthesisUtterance.onerror', event); const voice = voices.find(v => v.lang === langCode) || voices.find(v => v.lang.startsWith(langCode.split('-')[0])); if (voice) { utterThis.voice = voice; } else { utterThis.lang = langCode; console.warn(`No specific voice found for ${langCode}, using default.`); } utterThis.pitch = 1; utterThis.rate = 0.8; setTimeout(() => { synth.speak(utterThis); }, 75); } }
        function playEncouragement() { const randomIndex = Math.floor(Math.random() * encouragementPhrases.length); const phrase = encouragementPhrases[randomIndex]; speak(phrase, 'zh-CN', true); } // Allow interruption

        // --- Functions ---

        function populateTOC() { /* ... (no changes) ... */ tocListContainer.innerHTML = ''; characters.forEach((charData, index) => { const tocItem = document.createElement('div'); tocItem.classList.add('toc-item'); tocItem.textContent = charData.char; tocItem.dataset.index = index; tocListContainer.appendChild(tocItem); }); }
        function updateTocHighlight() { /* ... (no changes) ... */ const previousActive = tocListContainer.querySelector('.toc-item.active'); if (previousActive) previousActive.classList.remove('active'); const currentActive = tocListContainer.querySelector(`.toc-item[data-index="${currentCharacterIndex}"]`); if (currentActive) { currentActive.classList.add('active'); currentActive.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } }

        // Updated function to initialize or update Hanzi Writer instances
        function setupHanziWriters(character) {
            if (!HanziWriter) { console.error("Hanzi Writer library not loaded!"); return; }

            // --- Configure Animation Writer ---
            animationTargetDiv.innerHTML = '';
            const animWidth = animationTargetDiv.clientWidth || 300;
            const animHeight = animationTargetDiv.clientHeight || 300;
            const animationOptions = { width: animWidth, height: animHeight, padding: 5, showOutline: false, showCharacter: true, strokeAnimationSpeed: 1, delayBetweenStrokes: 200, strokeColor: '#333' };
            try {
                 animationWriter = HanziWriter.create(animationTargetDiv, character, animationOptions);
                 animationWriter.animateCharacter();
            } catch (error) { console.error("Error creating Animation Writer:", error); animationTargetDiv.innerHTML = '<p class="text-red-500 text-center p-2">Error</p>'; }

            // --- Configure Quiz Writer ---
            quizTargetDiv.innerHTML = '';
            const quizWidth = quizTargetDiv.clientWidth || 300;
            const quizHeight = quizTargetDiv.clientHeight || 300;
            const quizOptions = { width: quizWidth, height: quizHeight, padding: 5, showOutline: true, showCharacter: false, strokeColor: '#166534', outlineColor: '#DDD', highlightOnComplete: true, highlightColor: '#86efac', strokeMistakeTolerance: 0.1, quizStartStrokeColor: '#AAA' };
            try {
                 quizWriter = HanziWriter.create(quizTargetDiv, character, quizOptions);
                 quizWriter.quiz({
                     onComplete: function(summaryData) {
                         console.log('Quiz Complete!', summaryData);
                         playEncouragement(); // Play random encouragement regardless of mistakes
                     }
                 });
            } catch (error) { console.error("Error creating Quiz Writer:", error); quizTargetDiv.innerHTML = '<p class="text-red-500 text-center p-2">Error</p>'; }
        }

        // Updated function to display character using Hanzi Writers
        function displayCharacter() {
             if (currentCharacterIndex < 0 || currentCharacterIndex >= characters.length) { console.error("Invalid index:", currentCharacterIndex); currentCharacterIndex = 0; if (characters.length === 0) return; }
             const currentCharData = characters[currentCharacterIndex];
             meaningEmoji.textContent = currentCharData.emoji || '';
             setupHanziWriters(currentCharData.char);
             speak(currentCharData.char, 'zh-CN', true);
             updateTocHighlight();
        }

        function retryQuiz() { /* ... (no changes) ... */ if (quizWriter) { quizWriter.quiz(); } }
        function previousCharacter() { /* ... (no changes) ... */ if (characters.length === 0 || randomCheckbox.checked) return; currentCharacterIndex = (currentCharacterIndex - 1 + characters.length) % characters.length; displayCharacter(); }
        function nextCharacter() { /* ... (no changes) ... */ if (characters.length === 0) return; const isRandom = randomCheckbox.checked; let nextIndex; if (isRandom) { if (characters.length <= 1) nextIndex = 0; else do { nextIndex = Math.floor(Math.random() * characters.length); } while (nextIndex === currentCharacterIndex); } else { nextIndex = (currentCharacterIndex + 1) % characters.length; } currentCharacterIndex = nextIndex; displayCharacter(); }
        function handleTocClick(event) { /* ... (no changes) ... */ const target = event.target; if (target.classList.contains('toc-item') && target.dataset.index !== undefined) { const index = parseInt(target.dataset.index, 10); if (!isNaN(index) && index >= 0 && index < characters.length) { currentCharacterIndex = index; displayCharacter(); } } }
        function enterFullscreen() { /* ... (no changes) ... */ const elem = document.getElementById('mainContentArea'); if (!elem) { console.error("Fullscreen target #mainContentArea not found."); return; } if (elem.requestFullscreen) { elem.requestFullscreen().catch(err => console.error(`Fullscreen error: ${err.message} (${err.name})`)); } else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); } else if (elem.msRequestFullscreen) { elem.msRequestFullscreen(); } else { console.warn("Fullscreen API not fully supported by this browser."); } }
        function togglePrevButton() { prevBtn.disabled = randomCheckbox.checked; }
        function debounce(func, wait, immediate) { /* ... (no changes) ... */ var timeout; return function() { var context = this, args = arguments; var later = function() { timeout = null; if (!immediate) func.apply(context, args); }; var callNow = immediate && !timeout; clearTimeout(timeout); timeout = setTimeout(later, wait); if (callNow) func.apply(context, args); }; };

        // Updated resize handler with initialization flag check
        const handleResize = debounce(function() {
             if (isInitializing) return;
             console.log("Handling resize...");
             if (characters.length > 0) {
                setTimeout(() => {
                     if (animationTargetDiv.clientWidth > 0 && quizTargetDiv.clientWidth > 0) { displayCharacter(); }
                     else { console.warn("Resize handler skipped: Target divs have no dimensions yet."); }
                }, 100);
            }
        }, 250);

        // --- Event Listeners ---
        clearBtn.addEventListener('click', retryQuiz);
        prevBtn.addEventListener('click', previousCharacter);
        nextBtn.addEventListener('click', nextCharacter);
        fullscreenBtn.addEventListener('click', enterFullscreen);
        tocListContainer.addEventListener('click', handleTocClick);
        randomCheckbox.addEventListener('change', togglePrevButton);
        window.addEventListener('resize', handleResize);

        // --- Initialization ---
        populateTOC();
        if (characters.length > 0) {
            requestAnimationFrame(() => {
                setTimeout(() => {
                     displayCharacter();
                     isInitializing = false;
                     console.log("Initialization complete.");
                }, 100);
            });
        } else {
            console.error("No characters loaded.");
            isInitializing = false;
        }
        togglePrevButton();

        // --- Safety Note ---
        console.log("Tip: For the best 'locked-in' experience on iPad, use 'Guided Access' in Settings > Accessibility.");

    </script>
</body>
</html>
